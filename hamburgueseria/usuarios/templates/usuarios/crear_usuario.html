{% block content %}
<div class="min-h-screen bg-negro-principal py-12 px-4 relative overflow-hidden">
    
    <!-- Partículas de fondo -->
    <div id="particles-bg" class="absolute inset-0 pointer-events-none"></div>
    
    <!-- Elementos decorativos -->
    <div class="absolute top-0 left-0 w-96 h-96 bg-rojo-intenso/5 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 right-0 w-96 h-96 bg-rojo-suave/5 rounded-full blur-3xl"></div>

    <div class="bg-gris-oscuro text-blanco p-8 md:p-10 rounded-2xl shadow-2xl border border-gris-medio/10 max-w-3xl mx-auto relative z-10 backdrop-blur-sm" id="form-container">
        
        <!-- Esquinas decorativas -->
        <div class="absolute top-0 left-0 w-12 h-12 border-l-2 border-t-2 border-rojo-intenso/30 rounded-tl-2xl"></div>
        <div class="absolute top-0 right-0 w-12 h-12 border-r-2 border-t-2 border-rojo-intenso/30 rounded-tr-2xl"></div>
        <div class="absolute bottom-0 left-0 w-12 h-12 border-l-2 border-b-2 border-rojo-intenso/30 rounded-bl-2xl"></div>
        <div class="absolute bottom-0 right-0 w-12 h-12 border-r-2 border-b-2 border-rojo-intenso/30 rounded-br-2xl"></div>

        <!-- Header del formulario -->
        <div class="text-center mb-8" id="form-header">
            <div class="inline-block mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-rojo-intenso to-rojo-suave rounded-2xl flex items-center justify-center mx-auto floating">
                    <svg class="w-8 h-8 text-blanco" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                </div>
            </div>
            <h2 class="text-3xl font-black mb-2">Crear Usuario</h2>
            <p class="text-gris-medio text-sm">Completa el formulario para registrar un nuevo usuario</p>
            <div class="mt-4 h-1 w-24 bg-gradient-to-r from-rojo-intenso to-rojo-suave mx-auto rounded-full"></div>
        </div>

        <form method="post" id="user-form" class="space-y-6">
            {% csrf_token %}

            {% if form.errors %}
            <div class="bg-rojo-intenso/10 border-2 border-rojo-intenso text-rojo-intenso p-4 rounded-xl mb-6 animate-pulse" id="error-container">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <strong class="font-bold">Corrige los siguientes errores:</strong>
                        <ul class="list-disc ml-6 mt-2 space-y-1">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Grid de campos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Nombres -->
                <div class="form-field">
                    <label for="{{ form.first_name.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Nombres
                    </label>
                    <input type="text" 
                           name="{{ form.first_name.name }}" 
                           id="{{ form.first_name.id_for_label }}" 
                           value="{{ form.first_name.value|default:'' }}"
                           required
                           maxlength="50"
                           placeholder="Ej: Juan Carlos"
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Apellidos -->
                <div class="form-field">
                    <label for="{{ form.last_name.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Apellidos
                    </label>
                    <input type="text" 
                           name="{{ form.last_name.name }}" 
                           id="{{ form.last_name.id_for_label }}" 
                           value="{{ form.last_name.value|default:'' }}"
                           required
                           maxlength="50"
                           placeholder="Ej: Pérez García"
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Carnet - Número -->
                <div class="form-field">
                    <label for="{{ form.carnet_numero.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Número de Carnet
                    </label>
                    <input type="text" 
                           name="{{ form.carnet_numero.name }}" 
                           id="{{ form.carnet_numero.id_for_label }}" 
                           value="{{ form.carnet_numero.value|default:'' }}"
                           required
                           maxlength="10"
                           placeholder="Ej: 12345678"
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Carnet - Complemento -->
                <div class="form-field">
                    <label for="{{ form.carnet_complemento.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-gris-medio rounded-full"></span>
                        Complemento (Opcional)
                    </label>
                    <select name="{{ form.carnet_complemento.name }}" 
                            id="{{ form.carnet_complemento.id_for_label }}" 
                            class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                        <option value="">Sin complemento</option>
                        <option value="LP" {% if form.carnet_complemento.value == "LP" %}selected{% endif %}>LP</option>
                        <option value="CB" {% if form.carnet_complemento.value == "CB" %}selected{% endif %}>CB</option>
                        <option value="SC" {% if form.carnet_complemento.value == "SC" %}selected{% endif %}>SC</option>
                        <option value="OR" {% if form.carnet_complemento.value == "OR" %}selected{% endif %}>OR</option>
                        <option value="PT" {% if form.carnet_complemento.value == "PT" %}selected{% endif %}>PT</option>
                        <option value="TJ" {% if form.carnet_complemento.value == "TJ" %}selected{% endif %}>TJ</option>
                        <option value="CH" {% if form.carnet_complemento.value == "CH" %}selected{% endif %}>CH</option>
                        <option value="BN" {% if form.carnet_complemento.value == "BN" %}selected{% endif %}>BN</option>
                        <option value="PD" {% if form.carnet_complemento.value == "PD" %}selected{% endif %}>PD</option>
                    </select>
                </div>

                <!-- Fecha de Nacimiento -->
                <div class="form-field">
                    <label for="{{ form.fecha_nacimiento.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Fecha de Nacimiento
                    </label>
                    <input type="date" 
                           name="{{ form.fecha_nacimiento.name }}" 
                           id="{{ form.fecha_nacimiento.id_for_label }}" 
                           value="{{ form.fecha_nacimiento.value|default:'' }}"
                           required
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                    <p class="text-gris-medio text-xs mt-2">Debes ser mayor de 18 años</p>
                </div>

                <!-- Teléfono -->
                <div class="form-field">
                    <label for="{{ form.telefono.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Teléfono
                    </label>
                    <input type="tel" 
                           name="{{ form.telefono.name }}" 
                           id="{{ form.telefono.id_for_label }}" 
                           value="{{ form.telefono.value|default:'' }}"
                           required
                           maxlength="15"
                           placeholder="Ej: 71234567"
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Email -->
                <div class="form-field md:col-span-2">
                    <label for="{{ form.email.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Correo Electrónico
                    </label>
                    <input type="email" 
                           name="{{ form.email.name }}" 
                           id="{{ form.email.id_for_label }}" 
                           value="{{ form.email.value|default:'' }}"
                           required
                           placeholder="correo@ejemplo.com"
                           class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Dirección -->
                <div class="form-field md:col-span-2">
                    <label for="{{ form.direccion.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Dirección
                    </label>
                    <textarea name="{{ form.direccion.name }}" 
                              id="{{ form.direccion.id_for_label }}" 
                              required
                              rows="2"
                              maxlength="200"
                              placeholder="Ej: Av. 6 de Agosto #1234, Zona Central"
                              class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium resize-none">{{ form.direccion.value|default:'' }}</textarea>
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Rol -->
                <div class="form-field">
                    <label for="{{ form.rol.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Rol
                    </label>
                    <select name="{{ form.rol.name }}" 
                            id="{{ form.rol.id_for_label }}" 
                            required
                            class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                        <option value="">Selecciona un rol</option>
                        <option value="admin" {% if form.rol.value == "admin" %}selected{% endif %}>Administrador</option>
                        <option value="cajero" {% if form.rol.value == "cajero" %}selected{% endif %}>Cajero</option>
                        <option value="cocinero" {% if form.rol.value == "cocinero" %}selected{% endif %}>Cocinero</option>
                    </select>
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>

                <!-- Username (Hidden - Auto-generado) -->
                <input type="hidden" name="{{ form.username.name }}" id="{{ form.username.id_for_label }}" value="{{ form.username.value|default:'' }}">
                
                <div class="form-field">
                    <label class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full pulse-dot"></span>
                        Usuario (Auto-generado)
                    </label>
                    <div class="relative">
                        <input type="text" 
                               id="username_display"
                               readonly
                               placeholder="Se generará automáticamente"
                               class="w-full px-4 py-3 bg-negro-principal/50 border-2 border-green-500/30 rounded-xl text-green-500 font-bold placeholder-gris-medio/50 cursor-not-allowed transition-all duration-300">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-gris-medio text-xs mt-2">Formato: carnet-complemento-iniciales (ej: 12345678-1a-jp)</p>
                </div>

                <!-- Contraseña -->
                <div class="form-field">
                    <label for="{{ form.password1.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Contraseña
                    </label>
                    <div class="relative">
                        <input type="password" 
                               name="{{ form.password1.name }}" 
                               id="{{ form.password1.id_for_label }}" 
                               required
                               minlength="8"
                               maxlength="20"
                               class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                        <button type="button" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gris-medio hover:text-blanco transition-colors"
                                onclick="togglePassword('{{ form.password1.id_for_label }}', this)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                    <p class="text-gris-medio text-xs mt-2">Entre 8 y 20 caracteres</p>
                </div>

                <!-- Confirmar Contraseña -->
                <div class="form-field">
                    <label for="{{ form.password2.id_for_label }}" class="block text-gris-claro text-sm font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-rojo-intenso rounded-full"></span>
                        Confirmar Contraseña
                    </label>
                    <div class="relative">
                        <input type="password" 
                               name="{{ form.password2.name }}" 
                               id="{{ form.password2.id_for_label }}" 
                               required
                               minlength="8"
                               maxlength="20"
                               class="w-full px-4 py-3 bg-negro-principal border-2 border-gris-medio/20 rounded-xl text-blanco placeholder-gris-medio/50 focus:outline-none focus:border-rojo-intenso focus:shadow-lg focus:shadow-rojo-intenso/20 transition-all duration-300 font-medium">
                        <button type="button" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gris-medio hover:text-blanco transition-colors"
                                onclick="togglePassword('{{ form.password2.id_for_label }}', this)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="error-message text-rojo-intenso text-sm mt-2 hidden"></div>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8 pt-6 border-t border-gris-medio/10">
                <a href="{% url 'usuarios:lista_usuarios' %}" 
                   class="text-gris-medio hover:text-blanco transition-all duration-300 font-medium flex items-center gap-2 group">
                    <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" 
                        id="submit-btn"
                        class="bg-gradient-to-r from-rojo-intenso to-rojo-suave hover:from-rojo-suave hover:to-rojo-intenso text-blanco font-black px-8 py-3 rounded-xl uppercase tracking-wider transition-all duration-300 transform hover:scale-105 hover:shadow-xl hover:shadow-rojo-intenso/40 relative overflow-hidden group">
                    <span class="relative z-10 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Guardar Usuario
                    </span>
                    <div class="absolute inset-0 bg-gradient-to-r from-blanco/0 via-blanco/20 to-blanco/0 transform translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                </button>
            </div>
        </form>
    </div>
</div>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'negro-principal': '#111111',
                    'gris-oscuro': '#1C1C1C',
                    'gris-medio': '#AAAAAA',
                    'blanco': '#FFFFFF',
                    'rojo-intenso': '#B51E23',
                    'rojo-suave': '#D9322A',
                    'gris-claro': '#E0E0E0'
                }
            }
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
    
    .floating {
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .particle {
        position: absolute;
        width: 2px;
        height: 2px;
        background: #B51E23;
        border-radius: 50%;
        pointer-events: none;
        opacity: 0;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }
</style>

<script>
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }

        if (typeof anime !== 'undefined') {
            anime({
                targets: icon,
                rotate: [0, 360],
                duration: 400,
                easing: 'easeOutExpo'
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Establecer fecha máxima (hoy) y mínima (hace 100 años)
        const fechaNacimientoInput = document.querySelector('input[name="fecha_nacimiento"]');
        if (fechaNacimientoInput) {
            const today = new Date();
            const maxDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const minDate = new Date(today.getFullYear() - 100, today.getMonth(), today.getDate());
            
            fechaNacimientoInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
            fechaNacimientoInput.setAttribute('min', minDate.toISOString().split('T')[0]);
        }

        // Crear partículas
        const particlesBg = document.getElementById('particles-bg');
        if (particlesBg) {
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particlesBg.appendChild(particle);
            }

            // Animar partículas
            if (typeof anime !== 'undefined') {
                anime({
                    targets: '.particle',
                    opacity: [0, 0.5, 0],
                    translateY: () => anime.random(-50, 50),
                    translateX: () => anime.random(-50, 50),
                    duration: () => anime.random(3000, 6000),
                    delay: anime.stagger(100),
                    loop: true,
                    easing: 'easeInOutQuad'
                });
            }
        }

        // Animaciones de entrada
        if (typeof anime !== 'undefined') {
            anime({
                targets: '#form-container',
                opacity: [0, 1],
                translateY: [50, 0],
                duration: 800,
                easing: 'easeOutExpo'
            });

            anime({
                targets: '#form-header',
                opacity: [0, 1],
                translateY: [-20, 0],
                duration: 600,
                delay: 200,
                easing: 'easeOutExpo'
            });

            anime({
                targets: '.form-field',
                opacity: [0, 1],
                translateX: [-30, 0],
                duration: 600,
                delay: anime.stagger(80, {start: 400}),
                easing: 'easeOutExpo'
            });
        }

        // Referencias a los campos
        const firstNameInput = document.querySelector('input[name="first_name"]');
        const lastNameInput = document.querySelector('input[name="last_name"]');
        const carnetNumeroInput = document.querySelector('input[name="carnet_numero"]');
        const carnetComplementoInput = document.querySelector('select[name="carnet_complemento"]');
        const usernameInput = document.querySelector('input[name="username"]'); // Campo oculto
        const usernameDisplay = document.getElementById('username_display'); // Campo visible
        const telefonoInput = document.querySelector('input[name="telefono"]');
        const password1 = document.querySelector('input[name="password1"]');
        const password2 = document.querySelector('input[name="password2"]');

        // Función para capitalizar nombres
        function capitalizeName(text) {
            return text.split(' ')
                .filter(word => word.length > 0)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        // Generar username automáticamente
        function generateUsername() {
            if (!firstNameInput || !lastNameInput || !carnetNumeroInput || !usernameInput || !usernameDisplay) return;

            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const carnetNumero = carnetNumeroInput.value.trim();
            const carnetComplemento = carnetComplementoInput ? carnetComplementoInput.value.trim().toLowerCase() : '';

            if (carnetNumero && firstName && lastName) {
                const firstInitial = firstName.charAt(0).toLowerCase();
                const lastInitial = lastName.charAt(0).toLowerCase();
                
                let username = carnetNumero;
                if (carnetComplemento) {
                    username += '-' + carnetComplemento;
                }
                username += '-' + firstInitial + lastInitial;
                
                // Actualizar ambos campos: el oculto y el visible
                usernameInput.value = username;
                usernameDisplay.value = username;
                
                if (typeof anime !== 'undefined') {
                    anime({
                        targets: usernameDisplay,
                        scale: [1, 1.05, 1],
                        duration: 400,
                        easing: 'easeOutExpo'
                    });
                }
            } else {
                usernameInput.value = '';
                usernameDisplay.value = '';
            }
        }

        // Validación y formateo de nombres
        if (firstNameInput && lastNameInput) {
            [firstNameInput, lastNameInput].forEach(input => {
                input.addEventListener('input', function() {
                    let value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
                    value = value.replace(/\s+/g, ' ');
                    this.value = value;
                    generateUsername();
                });

                input.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        this.value = capitalizeName(this.value.trim());
                        generateUsername();
                    }
                });
            });
        }

        // Validación de carnet
        if (carnetNumeroInput) {
            carnetNumeroInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                generateUsername();
            });
        }

        // Actualizar username cuando cambia el complemento
        if (carnetComplementoInput) {
            carnetComplementoInput.addEventListener('change', generateUsername);
        }

        // Validación de teléfono
        if (telefonoInput) {
            telefonoInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9+\-\s]/g, '');
            });
        }

        // Función para calcular edad exacta
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            const dayDiff = today.getDate() - birth.getDate();
            
            if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
                age--;
            }
            
            return age;
        }

        // Validar edad en tiempo real
        if (fechaNacimientoInput) {
            fechaNacimientoInput.addEventListener('change', function() {
                if (this.value) {
                    const birthDate = new Date(this.value);
                    const today = new Date();
                    
                    if (birthDate > today) {
                        showError(this, 'No puedes ingresar una fecha futura');
                        return;
                    }
                    
                    const age = calculateAge(this.value);
                    const errorDiv = this.nextElementSibling;
                    
                    if (age < 18) {
                        showError(this, `Edad actual: ${age} años. Debes ser mayor de 18 años`);
                    } else if (age > 100) {
                        showError(this, 'La fecha ingresada no es válida');
                    } else {
                        if (errorDiv && errorDiv.classList.contains('error-message')) {
                            errorDiv.classList.add('hidden');
                            this.classList.remove('border-rojo-intenso');
                        }
                    }
                }
            });
        }

        // Validación de contraseñas en tiempo real
        function validatePasswords() {
            if (!password1 || !password2) return;

            const pass1 = password1.value;
            const pass2 = password2.value;
            const errorMsg = password2.parentElement.nextElementSibling;

            if (pass2 && pass1 !== pass2) {
                if (errorMsg && errorMsg.classList.contains('error-message')) {
                    errorMsg.textContent = 'Las contraseñas no coinciden';
                    errorMsg.classList.remove('hidden');
                    password2.classList.add('border-rojo-intenso');
                    
                    if (typeof anime !== 'undefined') {
                        anime({
                            targets: password2,
                            translateX: [0, -10, 10, -10, 10, 0],
                            duration: 400,
                            easing: 'easeInOutSine'
                        });
                    }
                }
            } else {
                if (errorMsg && errorMsg.classList.contains('error-message')) {
                    errorMsg.classList.add('hidden');
                    password2.classList.remove('border-rojo-intenso');
                }
            }
        }

        if (password1 && password2) {
            password1.addEventListener('input', validatePasswords);
            password2.addEventListener('input', validatePasswords);
        }

        // Función para mostrar errores
        function showError(input, message) {
            const errorDiv = input.parentElement.querySelector('.error-message') || 
                           input.nextElementSibling;
            if (errorDiv && errorDiv.classList.contains('error-message')) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                input.classList.add('border-rojo-intenso');
                
                if (typeof anime !== 'undefined') {
                    anime({
                        targets: input,
                        translateX: [0, -10, 10, -10, 10, 0],
                        duration: 400,
                        easing: 'easeInOutSine'
                    });
                }

                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    input.classList.remove('border-rojo-intenso');
                }, 5000);
            }
        }

        // Limpiar errores al escribir
        const allInputs = document.querySelectorAll('input, select, textarea');
        allInputs.forEach(input => {
            input.addEventListener('input', function() {
                const errorDiv = this.parentElement.querySelector('.error-message') || 
                               this.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('error-message')) {
                    errorDiv.classList.add('hidden');
                    this.classList.remove('border-rojo-intenso');
                }
            });

            input.addEventListener('change', function() {
                const errorDiv = this.parentElement.querySelector('.error-message') || 
                               this.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('error-message')) {
                    errorDiv.classList.add('hidden');
                    this.classList.remove('border-rojo-intenso');
                }
            });
        });

        // Animación de focus en inputs
        const inputs = document.querySelectorAll('input:not([readonly]), select, textarea');
        if (typeof anime !== 'undefined') {
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    anime({
                        targets: this,
                        scale: [1, 1.02, 1],
                        duration: 300,
                        easing: 'easeOutExpo'
                    });
                });
            });
        }

        // Efecto hover en labels
        const labels = document.querySelectorAll('label');
        if (typeof anime !== 'undefined') {
            labels.forEach(label => {
                const inputId = label.getAttribute('for');
                const input = inputId ? document.getElementById(inputId) : null;
                if (input) {
                    input.addEventListener('focus', () => {
                        anime({
                            targets: label,
                            color: '#B51E23',
                            duration: 300,
                            easing: 'easeOutExpo'
                        });
                    });

                    input.addEventListener('blur', () => {
                        anime({
                            targets: label,
                            color: '#E0E0E0',
                            duration: 300,
                            easing: 'easeOutExpo'
                        });
                    });
                }
            });
        }
    });
</script>
{% endblock %}